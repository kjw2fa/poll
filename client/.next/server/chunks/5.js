"use strict";exports.id=5,exports.ids=[5],exports.modules={74005:(a,b,c)=>{c.d(b,{ApolloServerPluginUsageReporting:()=>G});var d=c(14208),e=c(26522),f=c(4154),g=c(42539),h=c(21820),i=c(74075),j=c(63449),k=c(94243),l=c(90973);function m(a,b,c){let d=c?new p:o;if(!(a.root&&n(a.root,d,b))&&a.queryPlan&&function a(b,c,d){return!!b&&(b.fetch?.trace?.root&&b.fetch.serviceName?n(b.fetch.trace.root,c.child(`service:${b.fetch.serviceName}`),d):b.flatten?.node?a(b.flatten.node,c,d):b.parallel?.nodes?b.parallel.nodes.some(b=>a(b,c,d)):!!b.sequence?.nodes&&b.sequence.nodes.some(b=>a(b,c,d)))}(a.queryPlan,d,b))return}function n(a,b,c){return!!c(a,b)||(a.child?.some(a=>{let d=a.responseName?b.child(a.responseName):b;return n(a,d,c)})??!1)}let o={toArray(){throw Error("not collecting paths!")},child(){return this}};class p{toArray(){return[]}child(a){return new q(a,this)}}class q{responseName;prev;constructor(a,b){this.responseName=a,this.prev=b}toArray(){let a=[],b=this;for(;b instanceof q;)a.push(b.responseName),b=b.prev;return a.reverse()}child(a){return new q(a,this)}}class r{buckets;static BUCKET_COUNT=384;static EXPONENT_LOG=Math.log(1.1);toArray(){let a=0,b=[];for(let c of this.buckets)0===c?a++:(1===a?b.push(0):0!==a&&b.push(-a),b.push(Math.floor(c)),a=0);return b}static durationToBucket(a){let b=Math.ceil(Math.log(a/1e3)/r.EXPONENT_LOG);return b<=0||Number.isNaN(b)?0:b>=r.BUCKET_COUNT?r.BUCKET_COUNT-1:b}incrementDuration(a,b=1){return this.incrementBucket(r.durationToBucket(a),b),this}incrementBucket(a,b=1){if(a>=r.BUCKET_COUNT)throw Error("Bucket is out of bounds of the buckets array");if(a>=this.buckets.length){let b=this.buckets.length;this.buckets.length=a+1,this.buckets.fill(0,b)}this.buckets[a]+=b}combine(a){for(let b=0;b<a.buckets.length;b++)this.incrementBucket(b,a.buckets[b])}constructor(a){let b=a?.initSize||74,c=a?.buckets,d=Math.max(c?.length||0,b);this.buckets=Array(d).fill(0),c&&c.forEach((a,b)=>this.buckets[b]=a)}}class s{bytes=0}class t{header;tracesPreAggregated=!1;constructor(a){this.header=a}tracesPerQuery=Object.create(null);endTime=null;operationCount=0;sizeEstimator=new s;ensureCountsAreIntegers(){for(let a of Object.values(this.tracesPerQuery))a.ensureCountsAreIntegers()}addTrace({statsReportKey:a,trace:b,asTrace:c,referencedFieldsByType:e,maxTraceBytes:f=0xa00000,nonFtv1ErrorPaths:g}){let h=this.getTracesAndStats({statsReportKey:a,referencedFieldsByType:e});if(c){let a=d.Cn.encode(b).finish();!isNaN(f)&&a.length>f?h.statsWithContext.addTrace(b,this.sizeEstimator,g):(h.trace.push(a),this.sizeEstimator.bytes+=2+a.length)}else h.statsWithContext.addTrace(b,this.sizeEstimator,g)}getTracesAndStats({statsReportKey:a,referencedFieldsByType:b}){let c=this.tracesPerQuery[a];if(c)return c;for(let[c,d]of(this.sizeEstimator.bytes+=B(a),Object.entries(b)))for(let a of(this.sizeEstimator.bytes+=4,d.isInterface&&(this.sizeEstimator.bytes+=2),this.sizeEstimator.bytes+=B(c),d.fieldNames))this.sizeEstimator.bytes+=B(a);return this.tracesPerQuery[a]=new u(b)}}class u{referencedFieldsByType;constructor(a){this.referencedFieldsByType=a}trace=[];statsWithContext=new v;internalTracesContributingToStats=[];ensureCountsAreIntegers(){this.statsWithContext.ensureCountsAreIntegers()}}class v{map=Object.create(null);toArray(){return Object.values(this.map)}ensureCountsAreIntegers(){for(let a of Object.values(this.map))a.ensureCountsAreIntegers()}addTrace(a,b,c){this.getContextualizedStats(a,b).addTrace(a,b,c)}getContextualizedStats(a,b){let c={clientName:a.clientName,clientVersion:a.clientVersion},d=JSON.stringify(c),e=this.map[d];if(e)return e;b.bytes+=20+B(a.clientName)+B(a.clientVersion);let f=new w(c);return this.map[d]=f,f}}class w{context;queryLatencyStats=new x;perTypeStat=Object.create(null);constructor(a){this.context=a}ensureCountsAreIntegers(){for(let a of Object.values(this.perTypeStat))a.ensureCountsAreIntegers()}addTrace(a,b,c=[]){let{fieldExecutionWeight:e}=a;if(!e&&this.queryLatencyStats.requestsWithoutFieldInstrumentation++,this.queryLatencyStats.requestCount++,a.fullQueryCacheHit?(this.queryLatencyStats.cacheLatencyCount.incrementDuration(a.durationNs),this.queryLatencyStats.cacheHits++):this.queryLatencyStats.latencyCount.incrementDuration(a.durationNs),!a.fullQueryCacheHit&&a.cachePolicy?.maxAgeNs!=null)switch(a.cachePolicy.scope){case d.Cn.CachePolicy.Scope.PRIVATE:this.queryLatencyStats.privateCacheTtlCount.incrementDuration(a.cachePolicy.maxAgeNs);break;case d.Cn.CachePolicy.Scope.PUBLIC:this.queryLatencyStats.publicCacheTtlCount.incrementDuration(a.cachePolicy.maxAgeNs)}a.persistedQueryHit&&this.queryLatencyStats.persistedQueryHits++,a.persistedQueryRegister&&this.queryLatencyStats.persistedQueryMisses++,a.forbiddenOperation&&this.queryLatencyStats.forbiddenOperationCount++,a.registeredOperation&&this.queryLatencyStats.registeredOperationCount++;let f=!1,g=new Set;for(let{subgraph:d,path:h}of(m(a,(a,c)=>{if(a.error?.length){f=!0;let d=this.queryLatencyStats.rootErrorStats;c.toArray().forEach(a=>{d=d.getChild(a,b)}),g.add(d),d.errorsCount+=a.error.length}if(e){let c=a.originalFieldName||a.responseName;if(a.parentType&&c&&a.type&&null!=a.endTime&&null!=a.startTime&&a.endTime>=a.startTime){let d=this.getTypeStat(a.parentType,b).getFieldStat(c,a.type,b);d.errorsCount+=a.error?.length??0,d.observedExecutionCount++,d.estimatedExecutionCount+=e,d.requestsWithErrorsCount+=+((a.error?.length??0)>0),d.latencyCount.incrementDuration(a.endTime-a.startTime,e)}}return!1},!0),c))if(f=!0,h){let a=this.queryLatencyStats.rootErrorStats.getChild(`service:${d}`,b);h.forEach(c=>{"string"==typeof c&&(a=a.getChild(c,b))}),g.add(a),a.errorsCount+=1}for(let a of g)a.requestsWithErrorsCount+=1;f&&this.queryLatencyStats.requestsWithErrorsCount++}getTypeStat(a,b){let c=this.perTypeStat[a];if(c)return c;b.bytes+=B(a);let d=new z;return this.perTypeStat[a]=d,d}}class x{latencyCount=new r;requestCount=0;requestsWithoutFieldInstrumentation=0;cacheHits=0;persistedQueryHits=0;persistedQueryMisses=0;cacheLatencyCount=new r;rootErrorStats=new y;requestsWithErrorsCount=0;publicCacheTtlCount=new r;privateCacheTtlCount=new r;registeredOperationCount=0;forbiddenOperationCount=0}class y{children=Object.create(null);errorsCount=0;requestsWithErrorsCount=0;getChild(a,b){let c=this.children[a];if(c)return c;let d=new y;return this.children[a]=d,b.bytes+=B(a)+4,d}}class z{perFieldStat=Object.create(null);getFieldStat(a,b,c){let d=this.perFieldStat[a];if(d)return d;c.bytes+=B(a)+B(b)+10;let e=new A(b);return this.perFieldStat[a]=e,e}ensureCountsAreIntegers(){for(let a of Object.values(this.perFieldStat))a.ensureCountsAreIntegers()}}class A{returnType;errorsCount=0;observedExecutionCount=0;estimatedExecutionCount=0;requestsWithErrorsCount=0;latencyCount=new r;constructor(a){this.returnType=a}ensureCountsAreIntegers(){this.estimatedExecutionCount=Math.floor(this.estimatedExecutionCount)}}function B(a){return 2+Buffer.byteLength(a)}var C=c(76905),D=c(53192),E=c(8426);let F={hostname:h.hostname(),agentVersion:`@apollo/server@${C.T}`,runtimeVersion:`node ${process.version}`,uname:`${h.platform()}, ${h.type()}, ${h.release()}, ${h.arch()})`};function G(a=Object.create(null)){let b=a.fieldLevelInstrumentation,c="number"==typeof b?async()=>Math.random()<b?1/b:0:b||(async()=>!0),h=null;return(0,j.R)({__internal_plugin_id__:"UsageReporting",__is_disabled_plugin__:!1,requestDidStart:async a=>h?h(a):{},async serverWillStart({logger:b,apollo:j,startedInBackground:n,schema:o}){let p,q,s=a.logger??b,{key:u,graphRef:v}=j;if(!(u&&v))throw Error("You've enabled usage reporting via ApolloServerPluginUsageReporting, but you also need to provide your Apollo API key and graph ref, via the APOLLO_KEY/APOLLO_GRAPH_REF environment variables or via `new ApolloServer({apollo: {key, graphRef})`.");if((0,E.e)(o))if(a.__onlyIfSchemaIsNotSubgraph)return s.warn("You have specified an Apollo API key and graph ref but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph; usage reporting is disabled. To enable usage reporting anyway, explicitly install `ApolloServerPluginUsageReporting`. To disable this warning, install `ApolloServerPluginUsageReportingDisabled`."),{};else s.warn("You have installed `ApolloServerPluginUsageReporting` but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph. If this was unintentional, remove `ApolloServerPluginUsageReporting` from your server's `plugins` array.");s.info(`Apollo usage reporting starting! See your graph at https://studio.apollographql.com/graph/${encodeURI(v)}/`);let w=a.sendReportsImmediately??n,x=null,y=new Map,z=a=>{let b=y.get(a);if(b)return b;let c=new t(new d.Y6({...F,executableSchemaId:a,graphRef:v}));return y.set(a,c),c},A=a.overrideReportedSchema?(0,D.u)(a.overrideReportedSchema):void 0;w||(q=setInterval(()=>I(),a.reportIntervalMs||1e4));let B=a.sendTraces??!0,C=a.experimental_sendOperationAsTrace??function(){let a=new l.q({maxSize:1048576,sizeCalculation:(a,b)=>b&&Buffer.byteLength(b)||0});return(b,c)=>{let d,e=b.endTime?.seconds;if(null==e)throw Error("programming error: endTime not set on trace");let f=(d=!1,m(b,function(a){return(a.error?.length??0)>0&&(d=!0),d},!1),d),g=JSON.stringify([c,r.durationToBucket(b.durationNs),Math.floor(e/60),f?Math.floor(e/5):""]);return!a.get(g)&&(a.set(g,!0),!0)}}(),G=!1;function H(a){if(p?.executableSchema===a)return p.executableSchemaId;let b=(0,D.u)((0,g.rK)(a));return p={executableSchema:a,executableSchemaId:b},b}async function I(){await Promise.all([...y.keys()].map(a=>J(a)))}async function J(b){return K(b).catch(b=>{a.reportErrorFunction?a.reportErrorFunction(b):s.error(b.message)})}let K=async b=>{let c=(a=>{let b=y.get(a);return b?(y.delete(a),b):null})(b);if(!c||0===Object.keys(c.tracesPerQuery).length&&0===c.operationCount)return;c.endTime=(0,k.Q)(new Date),c.ensureCountsAreIntegers();let e=d.pl.verify(c);if(e)throw Error(`Error verifying report: ${e}`);let g=d.pl.encode(c).finish();if(c=null,a.debugPrintReports){let a=d.pl.decode(g);s.info(`Apollo usage report: ${JSON.stringify(a.toJSON())}`)}let h=await new Promise((a,b)=>{(0,i.gzip)(g,(c,d)=>{c?b(c):a(d)})});g=null;let j=a.fetcher??fetch,l=await f(async()=>{let b=await j((a.endpointUrl||"https://usage-reporting.api.apollographql.com")+"/api/ingress/traces",{method:"POST",headers:{"user-agent":"ApolloServerPluginUsageReporting","x-api-key":u,"content-encoding":"gzip",accept:"application/json"},body:h,signal:AbortSignal.timeout(a.requestTimeoutMs??3e4)});if(!(b.status>=500)||!(b.status<600))return b;throw Error(`HTTP status ${b.status}, ${await b.text()||"(no body)"}`)},{retries:(a.maxAttempts||5)-1,minTimeout:a.minimumRetryDelayMs||100,factor:2}).catch(a=>{throw Error(`Error sending report to Apollo servers: ${a.message}`)});if(l.status<200||l.status>=300)throw Error(`Error sending report to Apollo servers: HTTP status ${l.status}, ${await l.text()||"(no body)"}`);if(B&&200===l.status&&l.headers.get("content-type")?.match(/^\s*application\/json\s*(?:;|$)/i)){let a,b=await l.text();try{a=JSON.parse(b)}catch(a){throw Error(`Error parsing response from Apollo servers: ${a}`)}!0===a.tracesIgnored&&(s.debug("This graph's organization does not have access to traces; sending all subsequent operations as stats."),B=!1)}a.debugPrintReports&&s.info(`Apollo usage report: status ${l.status}`)};return h=({metrics:b,schema:f,request:{http:g,variables:h}})=>{let i=new k.B({maskedBy:"ApolloServerPluginUsageReporting",sendErrors:a.sendErrors});i.startTiming(),b.startHrTime=i.startHrTime;let j=!1,m=!1,n=null;async function o(b){if(null===n){if("function"!=typeof a.includeRequest){n=!0;return}"boolean"!=typeof(n=await a.includeRequest(b))&&(s.warn("The 'includeRequest' async predicate function must return a boolean value."),n=!0)}}g&&(i.trace.http=new d.Cn.HTTP({method:d.Cn.HTTP.Method[g.method]||d.Cn.HTTP.Method.UNKNOWN}),a.sendHeaders&&function(a,b,c){if(c&&(!("none"in c)||!c.none)&&(!("all"in c)||c.all)){for(let[e,f]of b)if(!("exceptNames"in c&&c.exceptNames.some(a=>a.toLowerCase()===e))&&(!("onlyNames"in c)||c.onlyNames.some(a=>a.toLowerCase()===e)))switch(e){case"authorization":case"cookie":case"set-cookie":break;default:a.requestHeaders[e]=new d.Cn.HTTP.Values({value:[f]})}}}(i.trace.http,g.headers,a.sendHeaders));let p=!1;return{async didResolveSource(c){p=!0,b.persistedQueryHit&&(i.trace.persistedQueryHit=!0),b.persistedQueryRegister&&(i.trace.persistedQueryRegister=!0),h&&(i.trace.details=function(a,b,c){let e=new d.Cn.Details,f=(()=>{if(!b||!("transform"in b))return a;{let g=Object.keys(a);try{let f=b.transform({variables:a,operationString:c});var d=g,e=f;let h=Object.create(null);return d.forEach(a=>{h[a]=e[a]}),h}catch(b){var f=g;let a=Object.create(null);return f.forEach(b=>{a[b]="[PREDICATE_FUNCTION_ERROR]"}),a}}})();return Object.keys(f).forEach(a=>{if(!b||"none"in b&&b.none||"all"in b&&!b.all||"exceptNames"in b&&b.exceptNames.includes(a)||"onlyNames"in b&&!b.onlyNames.includes(a))e.variablesJson[a]="";else try{e.variablesJson[a]=void 0===f[a]?"":JSON.stringify(f[a])}catch(b){e.variablesJson[a]=JSON.stringify("[Unable to convert value to JSON]")}}),e}(h,a.sendVariableValues,c.source));let e=(a.generateClientInfo||function({request:a}){let b="apollographql-client-name",c="apollographql-client-version";return a.http?.headers?.get(b)||a.http?.headers?.get(c)?{clientName:a.http?.headers?.get(b),clientVersion:a.http?.headers?.get(c)}:a.extensions?.clientInfo?a.extensions.clientInfo:{}})(c);if(e){let{clientName:a,clientVersion:b}=e;i.trace.clientVersion=b||"",i.trace.clientName=a||""}},validationDidStart:async()=>async a=>{j=!!a&&0!==a.length},async didResolveOperation(a){if(m=void 0===a.operation,await o(a),n&&!m&&void 0===b.captureTraces){let d=await c(a);i.trace.fieldExecutionWeight="number"==typeof d?d:+!!d,b.captureTraces=!!i.trace.fieldExecutionWeight}},async executionDidStart(){if(b.captureTraces)return{willResolveField:({info:a})=>i.willResolveField(a)}},async didEncounterSubsequentErrors(a,b){i.didEncounterErrors(b)},async willSendSubsequentPayload(a,b){b.hasNext||await q(a)},async willSendResponse(a){p&&(a.errors&&i.didEncounterErrors(a.errors),"single"===a.response.body.kind&&await q(a))}};async function q(c){let g=!!c.operation;await o(c),i.stopTiming();let h=A??H(f);if(!1===n){g&&z(h).operationCount++;return}i.trace.fullQueryCacheHit=!!b.responseCacheHit,i.trace.forbiddenOperation=!!b.forbiddenOperation,i.trace.registeredOperation=!!b.registeredOperation;let k=c.overallCachePolicy.policyIfCacheable();async function p(){let h,k;if(G)return;await new Promise(a=>setImmediate(a));let n=A??H(f),{trace:o}=i;c.document?j?k=`## GraphQLValidationFailure
`:m&&(k=`## GraphQLUnknownOperationName
`):k=`## GraphQLParseFailure
`;let p=void 0===k;if(k)a.sendUnexecutableOperationDocuments&&(o.unexecutedOperationBody=c.source,o.unexecutedOperationName=c.request.operationName||""),h=Object.create(null);else{let b=function(){var b,d;if(!c.document)throw Error("No document?");let g=(b=c.queryHash,d=c.operationName||"",`${b}${d&&":"+d}`);x&&x.forSchema===f||(x={forSchema:f,cache:function({logger:a}){let b,c=0;return new l.q({sizeCalculation:a=>Buffer.byteLength(JSON.stringify(a),"utf8"),maxSize:0xa00000,dispose(){c++,(!b||new Date().getTime()-b.getTime()>6e4)&&(b=new Date,a.warn(`This server is processing a high number of unique operations.  A total of ${c} records have been ejected from the ApolloServerPluginUsageReporting signature cache in the past interval.  If you see this warning frequently, please open an issue on the Apollo Server repository.`),c=0)}})}({logger:s})});let h=x.cache.get(g);if(h)return h;let i={signature:(a.calculateSignature||e.usageReportingSignature)(c.document,c.operationName||""),referencedFieldsByType:(0,e.calculateReferencedFieldsByType)({document:c.document,schema:f,resolvedOperationName:c.operationName??null})};return x.cache.set(g,i),i}();k=`# ${c.operationName||"-"}
${b.signature}`,h=b.referencedFieldsByType}let q=d.Cn.verify(o);if(q)throw Error(`Error encoding trace: ${q}`);g&&z(n).operationCount++,z(n).addTrace({statsReportKey:k,trace:o,asTrace:B&&(!p||!!b.captureTraces)&&!b.nonFtv1ErrorPaths?.length&&C(o,k),referencedFieldsByType:h,nonFtv1ErrorPaths:b.nonFtv1ErrorPaths??[]}),(w||z(n).sizeEstimator.bytes>=(a.maxUncompressedReportSize||4194304))&&await J(n)}k&&(i.trace.cachePolicy=new d.Cn.CachePolicy({scope:"PRIVATE"===k.scope?d.Cn.CachePolicy.Scope.PRIVATE:"PUBLIC"===k.scope?d.Cn.CachePolicy.Scope.PUBLIC:d.Cn.CachePolicy.Scope.UNKNOWN,maxAgeNs:1e9*k.maxAge})),b.queryPlanTrace&&(i.trace.queryPlan=b.queryPlanTrace),p().catch(s.error.bind(s))}},{async serverWillStop(){q&&(clearInterval(q),q=void 0),G=!0,await I()}}}})}},76905:(a,b,c)=>{c.d(b,{T:()=>d});let d="5.0.0"}};