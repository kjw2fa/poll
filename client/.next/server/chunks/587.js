"use strict";exports.id=587,exports.ids=[587],exports.modules={94587:(a,b,c)=>{c.d(b,{ApolloServerPluginCacheControl:()=>i});var d=c(30218),e=c(18473),f=c(29159),g=c(63449),h=c(90973);function i(a=Object.create(null)){let b,c;return(0,g.R)({__internal_plugin_id__:"CacheControl",__is_disabled_plugin__:!1,async serverWillStart({schema:a}){b=new h.q({max:Object.values(a.getTypeMap()).filter(d.ML).length}),c=new h.q({max:Object.values(a.getTypeMap()).filter(d.YQ).flatMap(a=>Object.values(a.getFields())).length+Object.values(a.getTypeMap()).filter(d.kD).flatMap(a=>Object.values(a.getFields())).length})},async requestDidStart(g){function h(a){let c=b.get(a);if(c)return c;let d=function(a){if(a.astNode){let b=l(a.astNode.directives);if(b)return b}if(a.extensionASTNodes)for(let b of a.extensionASTNodes){let a=l(b.directives);if(a)return a}return{}}(a);return b.set(a,d),d}let i=a.defaultMaxAge??0,n=a.calculateHttpHeaders??!0,{__testing__cacheHints:o}=a;return{async executionDidStart(){if(m(g.overallCachePolicy)){let a=(0,f.D)();return{willResolveField({info:b}){b.cacheControl={setCacheHint:b=>{a.replace(b)},cacheHint:a,cacheHintFromType:h}}}}return{willResolveField({info:a}){let b=(0,f.D)(),j=!1,k=(0,d.MR)(a.returnType);if((0,d.ML)(k)){let a=h(k);b.replace(a),j=!!a.inheritMaxAge}let n=function(a){let b=c.get(a);if(b)return b;let d=function(a){if(a.astNode){let b=l(a.astNode.directives);if(b)return b}return{}}(a);return c.set(a,d),d}(a.parentType.getFields()[a.fieldName]);return n.inheritMaxAge&&void 0===b.maxAge?(j=!0,n.scope&&b.replace({scope:n.scope})):b.replace(n),a.cacheControl={setCacheHint:a=>{b.replace(a)},cacheHint:b,cacheHintFromType:h},()=>{if(void 0===b.maxAge&&((0,d.ML)(k)&&!j||!a.path.prev)&&b.restrict({maxAge:i}),o&&m(b)){let c=(0,e.A)(a.path).join(".");if(o.has(c))throw Error("shouldn't happen: addHint should only be called once per path");o.set(c,{maxAge:b.maxAge,scope:b.scope})}g.overallCachePolicy.restrict(b)}}}},async willSendResponse(a){if(!n)return;let{response:b,overallCachePolicy:c}=a,d=function(a){if(!a)return{kind:"no-header"};if(a===k)return{kind:"uncacheable"};let b=j.exec(a);return b?{kind:"parsable-and-cacheable",hint:{maxAge:+b[1],scope:"public"===b[2]?"PUBLIC":"PRIVATE"}}:{kind:"unparsable"}}(b.http.headers.get("cache-control"));if("unparsable"===d.kind)return;let e=(0,f.D)();e.replace(c),"parsable-and-cacheable"===d.kind&&e.restrict(d.hint);let g=e.policyIfCacheable();g&&"uncacheable"!==d.kind&&"single"===b.body.kind&&!b.body.singleResult.errors?b.http.headers.set("cache-control",`max-age=${g.maxAge}, ${g.scope.toLowerCase()}`):"if-cacheable"!==n&&b.http.headers.set("cache-control",k)}}}})}let j=/^max-age=(\d+), (public|private)$/,k="no-store";function l(a){if(!a)return;let b=a.find(a=>"cacheControl"===a.name.value);if(!b||!b.arguments)return;let c=b.arguments.find(a=>"maxAge"===a.name.value),d=b.arguments.find(a=>"scope"===a.name.value),e=b.arguments.find(a=>"inheritMaxAge"===a.name.value),f=d?.value?.kind==="EnumValue"?d.value.value:void 0,g="PUBLIC"===f||"PRIVATE"===f?f:void 0;return e?.value?.kind==="BooleanValue"&&e.value.value?{inheritMaxAge:!0,scope:g}:{maxAge:c?.value?.kind==="IntValue"?parseInt(c.value.value):void 0,scope:g}}function m(a){return void 0!==a.maxAge||void 0!==a.scope}}};